<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ê±áÂ∑ùÈ•ø‰∫Ü‰πàÊï∞ÊçÆÊä•Ë°®ÁÆ°ÁêÜ</title>
    <!-- Element Plus CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus@2.4.4/dist/index.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
        }

        #app {
            min-height: 100vh;
        }

        .main-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 0;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header-title {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-subtitle {
            font-size: 16px;
            opacity: 0.9;
        }

        .main-container {
            max-width: 1600px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .content-card {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }

        .action-bar {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .stats-value {
            font-size: 48px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .stats-label {
            font-size: 16px;
            opacity: 0.9;
        }

        .el-table {
            margin-top: 20px;
        }

        .el-form-item {
            margin-bottom: 18px;
        }

        .back-btn {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Â§¥ÈÉ® -->
        <div class="main-header">
            <div class="header-content">
                <div class="header-title">üçî Ê±áÂ∑ùÈ•ø‰∫Ü‰πàÊï∞ÊçÆÊä•Ë°®ÁÆ°ÁêÜ</div>
                <div class="header-subtitle">Elm Huichuan Performance Report Management</div>
            </div>
        </div>

        <!-- ‰∏ªÂÆπÂô® -->
        <div class="main-container">
            <!-- ËøîÂõûÊåâÈíÆ -->
            <el-button type="primary" @click="goBack" class="back-btn">
                ‚Üê ËøîÂõû‰∏ªÈ°µ
            </el-button>

            <!-- ÁªüËÆ°Âç°Áâá -->
            <div class="stats-card">
                <div class="stats-value">{{ elmHcReportList.length }}</div>
                <div class="stats-label">Êï∞ÊçÆÊä•Ë°®ÊÄªÊï∞</div>
            </div>

            <!-- ÂÜÖÂÆπÂç°Áâá -->
            <div class="content-card">
                <div class="action-bar">
                    <div>
                        <el-button type="primary" @click="showElmHcReportDialog('create')" icon="Plus">
                            Êñ∞Âª∫Êï∞ÊçÆÊä•Ë°®
                        </el-button>
                        <el-button @click="loadElmHcReportList" icon="Refresh">
                            Âà∑Êñ∞
                        </el-button>
                    </div>
                    <el-input
                        v-model="searchText"
                        placeholder="ÊêúÁ¥¢ÂÆ¢Êà∑ÁÆÄÁß∞„ÄÅ‰ª£ÁêÜÁÆÄÁß∞„ÄÅÂ™í‰ΩìÂπ≥Âè∞"
                        style="width: 300px;"
                        clearable
                    >
                        <template #prefix>
                            <el-icon><search /></el-icon>
                        </template>
                    </el-input>
                </div>

                <!-- Êï∞ÊçÆË°®Ê†º -->
                <el-table 
                    :data="filteredElmHcReportList" 
                    stripe 
                    border
                    style="width: 100%"
                    v-loading="loading"
                >
                    <el-table-column type="index" label="#" width="60" />
                    <el-table-column prop="customer_short" label="ÂÆ¢Êà∑ÁÆÄÁß∞" width="120" />
                    <el-table-column prop="customer_name" label="ÂÆ¢Êà∑ÂêçÁß∞" width="180" show-overflow-tooltip />
                    <el-table-column prop="agent_short" label="‰ª£ÁêÜÁÆÄÁß∞" width="100" />
                    <el-table-column prop="agent_name" label="‰ª£ÁêÜÂêçÁß∞" width="180" show-overflow-tooltip />
                    <el-table-column prop="media_platform_name" label="Â™í‰ΩìÂπ≥Âè∞" width="120" />
                    <el-table-column prop="media_adv_id" label="Â™í‰ΩìË¥¶Êà∑ID" width="140" />
                    <el-table-column prop="media_adv_name" label="Â™í‰ΩìË¥¶Êà∑ÂêçÁß∞" width="180" show-overflow-tooltip />
                    <el-table-column prop="huichuan_adv_id" label="Ê±áÂ∑ùË¥¶Êà∑ID" width="140" />
                    <el-table-column prop="redirect_num" label="Ë∞ÉËµ∑Êï∞" width="100" align="right">
                        <template #default="scope">
                            <el-tag type="info">{{ scope.row.redirect_num.toLocaleString() }}</el-tag>
                        </template>
                    </el-table-column>
                    <el-table-column prop="pay_num" label="‰ªòË¥πÊï∞" width="100" align="right">
                        <template #default="scope">
                            <el-tag type="success">{{ scope.row.pay_num.toLocaleString() }}</el-tag>
                        </template>
                    </el-table-column>
                    <el-table-column label="ËΩ¨ÂåñÁéá" width="100" align="right">
                        <template #default="scope">
                            <el-tag type="warning">
                                {{ scope.row.redirect_num > 0 ? ((scope.row.pay_num / scope.row.redirect_num) * 100).toFixed(2) + '%' : '0%' }}
                            </el-tag>
                        </template>
                    </el-table-column>
                    <el-table-column prop="update_time" label="Êõ¥Êñ∞Êó∂Èó¥" width="160" />
                    <el-table-column label="Êìç‰Ωú" width="160" fixed="right">
                        <template #default="scope">
                            <el-button size="small" type="primary" @click="showElmHcReportDialog('edit', scope.row)">
                                ÁºñËæë
                            </el-button>
                            <el-button size="small" type="danger" @click="deleteElmHcReport(scope.row)">
                                Âà†Èô§
                            </el-button>
                        </template>
                    </el-table-column>
                </el-table>
            </div>
        </div>

        <!-- ÂàõÂª∫/ÁºñËæëÂØπËØùÊ°Ü -->
        <el-dialog 
            v-model="elmHcReportDialogVisible" 
            :title="elmHcReportDialogMode === 'create' ? 'Êñ∞Âª∫Ê±áÂ∑ùÈ•ø‰∫Ü‰πàÊï∞ÊçÆÊä•Ë°®' : 'ÁºñËæëÊ±áÂ∑ùÈ•ø‰∫Ü‰πàÊï∞ÊçÆÊä•Ë°®'"
            width="700px"
        >
            <el-form :model="elmHcReportForm" label-width="130px">
                <el-row :gutter="20">
                    <el-col :span="12">
                        <el-form-item label="ÂÆ¢Êà∑ÂêçÁß∞" required>
                            <el-input v-model="elmHcReportForm.customer_name" placeholder="Â¶ÇÔºöÊãâÊâéÊñØÁΩëÁªúÁßëÊäÄÔºà‰∏äÊµ∑ÔºâÊúâÈôêÂÖ¨Âè∏" />
                        </el-form-item>
                    </el-col>
                    <el-col :span="12">
                        <el-form-item label="ÂÆ¢Êà∑ÁÆÄÁß∞" required>
                            <el-input v-model="elmHcReportForm.customer_short" placeholder="Â¶ÇÔºöÊ∑òÂÆùÈó™Ë¥≠" />
                        </el-form-item>
                    </el-col>
                </el-row>

                <el-row :gutter="20">
                    <el-col :span="12">
                        <el-form-item label="‰ª£ÁêÜÂêçÁß∞" required>
                            <el-input v-model="elmHcReportForm.agent_name" placeholder="Â¶ÇÔºöÂåó‰∫¨ÁæéÊï∞‰ø°ÊÅØÁßëÊäÄÊúâÈôêÂÖ¨Âè∏" />
                        </el-form-item>
                    </el-col>
                    <el-col :span="12">
                        <el-form-item label="‰ª£ÁêÜÁÆÄÁß∞" required>
                            <el-input v-model="elmHcReportForm.agent_short" placeholder="Â¶ÇÔºöÁæéÊï∞" />
                        </el-form-item>
                    </el-col>
                </el-row>

                <el-row :gutter="20">
                    <el-col :span="12">
                        <el-form-item label="Â™í‰ΩìÂπ≥Âè∞ÂêçÁß∞" required>
                            <el-input v-model="elmHcReportForm.media_platform_name" placeholder="Â¶ÇÔºöÂ∑®ÈáèÂºïÊìé" />
                        </el-form-item>
                    </el-col>
                    <el-col :span="12">
                        <el-form-item label="Â™í‰ΩìË¥¶Êà∑ID" required>
                            <el-input v-model="elmHcReportForm.media_adv_id" placeholder="Â¶ÇÔºö1234567890" />
                        </el-form-item>
                    </el-col>
                </el-row>

                <el-row :gutter="20">
                    <el-col :span="24">
                        <el-form-item label="Â™í‰ΩìË¥¶Êà∑ÂêçÁß∞" required>
                            <el-input v-model="elmHcReportForm.media_adv_name" placeholder="Â¶ÇÔºöÂ∑®ÈáèÂºïÊìéË¥¶Êà∑ÂêçÁß∞" />
                        </el-form-item>
                    </el-col>
                </el-row>

                <el-row :gutter="20">
                    <el-col :span="12">
                        <el-form-item label="Ê±áÂ∑ùË¥¶Êà∑ID" required>
                            <el-input-number v-model="elmHcReportForm.huichuan_adv_id" :min="0" :controls="false" style="width: 100%;" />
                        </el-form-item>
                    </el-col>
                </el-row>

                <el-row :gutter="20">
                    <el-col :span="12">
                        <el-form-item label="Ë∞ÉËµ∑Êï∞">
                            <el-input-number v-model="elmHcReportForm.redirect_num" :min="0" :controls="false" style="width: 100%;" />
                        </el-form-item>
                    </el-col>
                    <el-col :span="12">
                        <el-form-item label="‰ªòË¥πÊï∞">
                            <el-input-number v-model="elmHcReportForm.pay_num" :min="0" :controls="false" style="width: 100%;" />
                        </el-form-item>
                    </el-col>
                </el-row>
            </el-form>
            <template #footer>
                <el-button @click="elmHcReportDialogVisible = false">ÂèñÊ∂à</el-button>
                <el-button type="primary" @click="submitElmHcReport">Á°ÆÂÆö</el-button>
            </template>
        </el-dialog>
    </div>

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3.3.11/dist/vue.global.js"></script>
    <!-- Element Plus -->
    <script src="https://unpkg.com/element-plus@2.4.4/dist/index.full.js"></script>
    <!-- Axios -->
    <script src="https://unpkg.com/axios@1.6.2/dist/axios.min.js"></script>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;

        createApp({
            setup() {
                // API Base URL
                const API_BASE_URL = 'http://127.0.0.1:8888';
                // const API_BASE_URL = 'https://rta.zhltech.net/guangyixinmedia';

                // Êï∞ÊçÆÂàóË°®
                const elmHcReportList = ref([]);
                const loading = ref(false);
                const searchText = ref('');

                // ÂØπËØùÊ°Ü
                const elmHcReportDialogVisible = ref(false);
                const elmHcReportDialogMode = ref('create');
                const elmHcReportForm = ref({
                    id: null,
                    customer_name: '',
                    customer_short: '',
                    agent_name: '',
                    agent_short: '',
                    media_platform_name: '',
                    media_adv_id: '',
                    media_adv_name: '',
                    huichuan_adv_id: 0,
                    redirect_num: 0,
                    pay_num: 0
                });

                // ËøáÊª§ÂêéÁöÑÂàóË°®
                const filteredElmHcReportList = computed(() => {
                    if (!searchText.value) {
                        return elmHcReportList.value;
                    }
                    const keyword = searchText.value.toLowerCase();
                    return elmHcReportList.value.filter(item => {
                        return item.customer_short.toLowerCase().includes(keyword) ||
                               item.agent_short.toLowerCase().includes(keyword) ||
                               item.media_platform_name.toLowerCase().includes(keyword) ||
                               item.customer_name.toLowerCase().includes(keyword) ||
                               item.agent_name.toLowerCase().includes(keyword);
                    });
                });

                // ËøîÂõû‰∏ªÈ°µ
                const goBack = () => {
                    window.location.href = '/';
                };

                // Âä†ËΩΩÊï∞ÊçÆÂàóË°®
                const loadElmHcReportList = async () => {
                    loading.value = true;
                    try {
                        const response = await axios.get(`${API_BASE_URL}/config/elmhc/list`);
                        if (response.data.code === 0) {
                            elmHcReportList.value = response.data.data || [];
                        } else {
                            ElMessage.error(response.data.message || 'Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•');
                        }
                    } catch (error) {
                        ElMessage.error('ÁΩëÁªúÈîôËØØÔºö' + error.message);
                    } finally {
                        loading.value = false;
                    }
                };

                // ÊòæÁ§∫ÂØπËØùÊ°Ü
                const showElmHcReportDialog = (mode, row = null) => {
                    elmHcReportDialogMode.value = mode;
                    if (mode === 'create') {
                        elmHcReportForm.value = {
                            id: null,
                            customer_name: '',
                            customer_short: '',
                            agent_name: '',
                            agent_short: '',
                            media_platform_name: '',
                            media_adv_id: '',
                            media_adv_name: '',
                            huichuan_adv_id: 0,
                            redirect_num: 0,
                            pay_num: 0
                        };
                    } else {
                        elmHcReportForm.value = { ...row };
                    }
                    elmHcReportDialogVisible.value = true;
                };

                // Êèê‰∫§Êï∞ÊçÆ
                const submitElmHcReport = async () => {
                    // È™åËØÅÂøÖÂ°´Â≠óÊÆµ
                    if (!elmHcReportForm.value.customer_name || !elmHcReportForm.value.customer_short ||
                        !elmHcReportForm.value.agent_name || !elmHcReportForm.value.agent_short ||
                        !elmHcReportForm.value.media_platform_name || !elmHcReportForm.value.media_adv_id ||
                        !elmHcReportForm.value.media_adv_name || !elmHcReportForm.value.huichuan_adv_id) {
                        ElMessage.warning('ËØ∑Â°´ÂÜôÊâÄÊúâÂøÖÂ°´Â≠óÊÆµ');
                        return;
                    }

                    const url = elmHcReportDialogMode.value === 'create' 
                        ? `${API_BASE_URL}/config/elmhc/create`
                        : `${API_BASE_URL}/config/elmhc/update`;
                    
                    try {
                        const response = await axios.post(url, elmHcReportForm.value);
                        if (response.data.code === 0) {
                            ElMessage.success(elmHcReportDialogMode.value === 'create' ? 'ÂàõÂª∫ÊàêÂäü' : 'Êõ¥Êñ∞ÊàêÂäü');
                            elmHcReportDialogVisible.value = false;
                            loadElmHcReportList();
                        } else {
                            ElMessage.error(response.data.message || 'Êìç‰ΩúÂ§±Ë¥•');
                        }
                    } catch (error) {
                        ElMessage.error('ÁΩëÁªúÈîôËØØÔºö' + error.message);
                    }
                };

                // Âà†Èô§Êï∞ÊçÆ
                const deleteElmHcReport = async (row) => {
                    try {
                        await ElMessageBox.confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËØ•Êï∞ÊçÆÊä•Ë°®ÂêóÔºü', 'ÊèêÁ§∫', {
                            confirmButtonText: 'Á°ÆÂÆö',
                            cancelButtonText: 'ÂèñÊ∂à',
                            type: 'warning'
                        });
                        
                        const response = await axios.post(`${API_BASE_URL}/config/elmhc/delete`, {
                            id: row.id
                        });
                        
                        if (response.data.code === 0) {
                            ElMessage.success('Âà†Èô§ÊàêÂäü');
                            loadElmHcReportList();
                        } else {
                            ElMessage.error(response.data.message || 'Âà†Èô§Â§±Ë¥•');
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            ElMessage.error('ÁΩëÁªúÈîôËØØÔºö' + error.message);
                        }
                    }
                };

                // ÁªÑ‰ª∂ÊåÇËΩΩÊó∂Âä†ËΩΩÊï∞ÊçÆ
                onMounted(() => {
                    loadElmHcReportList();
                });

                return {
                    elmHcReportList,
                    loading,
                    searchText,
                    filteredElmHcReportList,
                    elmHcReportDialogVisible,
                    elmHcReportDialogMode,
                    elmHcReportForm,
                    goBack,
                    loadElmHcReportList,
                    showElmHcReportDialog,
                    submitElmHcReport,
                    deleteElmHcReport
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>
